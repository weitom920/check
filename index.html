<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä¸Šä¸‹ç­ / åŠ ç­æ‰“å¡ï¼ˆæœ¬æ©Ÿå„²å­˜ï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background:#f5f7fa; padding:16px; }
    h1 { font-size:1.4rem; }
    .card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 4px 12px rgba(0,0,0,0.08); margin-bottom:16px; }
    label { display:block; margin-top:12px; font-weight:600; }
    input, select, button { width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #ccc; font-size:1rem; }
    button { background:#2563eb; color:#fff; border:none; margin-top:12px; }
    button.secondary { background:#6b7280; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { border-bottom:1px solid #e5e7eb; padding:8px; font-size:0.8rem; }
    img { max-width:60px; border-radius:6px; }
  </style>
</head>
<body>
<h1>ğŸ“± ä¸Šä¸‹ç­ / åŠ ç­æ‰“å¡ï¼ˆè‡ªå‹•åˆ¤æ–·åŠ ç­ï¼‰</h1>

<div class="card">
  <h2>ğŸ“ å¦‚ä½•æ‰‹å‹•å–å¾— GPS ä½ç½®ï¼ˆè«‹ç…§ä¸‹é¢æ­¥é©Ÿï¼‰</h2>
  <ol style="font-size:0.9rem; line-height:1.6; padding-left:18px;">
    <li>é–‹å•Ÿ <b>Google Maps</b></li>
    <li>é•·æŒ‰ä½ ç›®å‰æ‰€åœ¨çš„ä½ç½®ï¼ˆå‡ºç¾ç´…è‰²åœ–é‡˜ï¼‰</li>
    <li>é»é¸ã€Œåˆ†äº«ã€</li>
    <li>é¸æ“‡ã€Œè¤‡è£½é€£çµã€</li>
    <li>å°‡é€£çµè²¼åˆ°ä¸‹æ–¹çš„ã€ŒGPS ä½ç½®ã€æ¬„ä½</li>
  </ol>
  <p style="font-size:0.85rem; color:#555;">â€» è‹¥ç„¡æ³•ä½¿ç”¨ Google Mapsï¼Œä¹Ÿå¯ç›´æ¥è¼¸å…¥åœ°å€æˆ–åœ°é»åç¨±ã€‚</p>

  <label>å§“å</label></label>
  <input id="name" />

  <label>æ‰“å¡é¡å‹</label>
  <select id="type">
    <option value="ä¸Šç­">ä¸Šç­</option>
    <option value="ä¸‹ç­">ä¸‹ç­</option>
    <option value="åŠ ç­">åŠ ç­</option>
  </select>

  <label>æ—¥æœŸæ™‚é–“</label>
  <input id="datetime" type="datetime-local" />

  <label>å¸¸ç”¨åœ°é»å¿«é€Ÿé¸æ“‡</label>
  <select id="presetLocation" onchange="applyPreset()"></select>

  <label>è¨­å®šï¼šè¾¦å…¬å®¤åœ°é»ï¼ˆåƒ…å­˜æœ¬æ©Ÿï¼‰</label>
  <input id="officeSetting" placeholder="è²¼ä¸Šè¾¦å…¬å®¤ Google Maps é€£çµæˆ–åœ°å€" />
  <button type="button" class="secondary" onclick="saveOffice()">ğŸ’¾ å„²å­˜è¾¦å…¬å®¤åœ°é»</button>

  <label>GPS ä½ç½®ï¼ˆæ‰‹å‹•è¼¸å…¥ / è²¼ä¸Šåœ°åœ–é€£çµï¼‰</label>
  <input id="location" placeholder="è«‹è¼¸å…¥åœ°å€ æˆ– è²¼ä¸Š Google Maps é€£çµ" />

  <!-- GPS è‡ªå‹•å–å¾—å·²ç§»é™¤ï¼Œé¿å…ç€è¦½å™¨æ¬Šé™å•é¡Œ -->

  <button style="display:none" onclick="getLocation()">ğŸ“ å–å¾—ä½ç½®</button>
  <button onclick="saveRecord()">âœ… æ‰“å¡</button>
</div>

<div class="card">
  <h2>ğŸ“Š å·¥æ™‚çµ±è¨ˆ</h2>
  <div id="summary"></div>
  <button class="secondary" onclick="exportExcel()">ğŸ“ åŒ¯å‡º Excel</button>
</div>

<div class="card">
  <h2>ğŸ“„ æ‰“å¡ç´€éŒ„</h2>
  <table>
    <thead>
      <tr><th>å§“å</th><th>é¡å‹</th><th>æ™‚é–“</th><th>æ˜¯å¦åŠ ç­</th><th>GPS</th><th>ç…§ç‰‡</th></tr>
    </thead>
    <tbody id="records"></tbody>
  </table>
</div>

<script>
const KEY = 'clock_records_v3';
const OFFICE_KEY = 'office_location';
const WORK_END_HOUR = 18; // 18:00 å¾Œè‡ªå‹•ç®—åŠ ç­

function getLocation() {
  navigator.geolocation.getCurrentPosition(p => {
    location.value = `https://www.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}`;
  });
}

function saveRecord() {
  const dt = new Date(datetime.value);
  const isOvertime = dt.getHours() >= WORK_END_HOUR;
  const reader = new FileReader();
  const file = photo.files[0];

  reader.onload = () => {
    const record = { name: name.value, type: type.value, datetime: datetime.value, overtime: isOvertime, location: location.value, image: reader.result || null };
    const data = JSON.parse(localStorage.getItem(KEY) || '[]');
    data.push(record);
    localStorage.setItem(KEY, JSON.stringify(data));
    load();
initPreset();

function initPreset() {
  const office = localStorage.getItem(OFFICE_KEY) || '';
  officeSetting.value = office;
  presetLocation.innerHTML = `
    <option value="">è«‹é¸æ“‡å¸¸ç”¨åœ°é»</option>
    ${office ? `<option value="office">è¾¦å…¬å®¤</option>` : ''}
    <option value="custom">å¤–å‹¤ / å·¥åœ°ï¼ˆè‡ªè¡Œè¼¸å…¥ï¼‰</option>`;
}

function saveOffice() {
  if (!officeSetting.value) return alert('è«‹è¼¸å…¥è¾¦å…¬å®¤åœ°é»');
  localStorage.setItem(OFFICE_KEY, officeSetting.value);
  alert('è¾¦å…¬å®¤åœ°é»å·²å„²å­˜ï¼ˆåƒ…æ­¤è£ç½®ï¼‰');
  initPreset();
}

function applyPreset() {
  const v = presetLocation.value;
  if (v === 'office') {
    location.value = localStorage.getItem(OFFICE_KEY) || '';
  }
  if (v === 'custom') {
    location.value = '';
  }
}

function applyPreset() {
  const v = presetLocation.value;
  if (!v) return;
  if (v.includes('ï½œ')) {
    location.value = v.split('ï½œ')[1];
  } else {
    location.value = v;
  }
}
  };
  if (file) reader.readAsDataURL(file); else reader.onload();
}

function load() {
  const data = JSON.parse(localStorage.getItem(KEY) || '[]');
  records.innerHTML = '';
  let total = 0, overtime = 0;

  data.forEach(r => {
    if (r.type === 'ä¸‹ç­') {
      total += 8;
      if (r.overtime) overtime += (new Date(r.datetime).getHours() - WORK_END_HOUR);
    }
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.name}</td><td>${r.type}</td><td>${r.datetime}</td><td>${r.overtime ? 'æ˜¯' : 'å¦'}</td><td><a href='${r.location}' target='_blank'>åœ°åœ–</a></td><td>${r.image ? `<img src='${r.image}'>` : ''}</td>`;
    records.appendChild(tr);
  });

  summary.innerHTML = `ğŸ•’ ç¸½å·¥æ™‚ï¼šç´„ ${total} å°æ™‚<br>â±ï¸ åŠ ç­ï¼šç´„ ${overtime} å°æ™‚`;
}

function exportExcel() {
  const data = JSON.parse(localStorage.getItem(KEY) || '[]');
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'æ‰“å¡ç´€éŒ„');
  XLSX.writeFile(wb, 'clock_records.xlsx');
}

load();
</script>
</body>
</html>
