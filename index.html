<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä¸Šä¸‹ç­ / åŠ ç­æ‰“å¡ï¼ˆæœ¬æ©Ÿå„²å­˜ï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background:#fff7ed; padding:16px; }
    h1 { font-size:1.6rem; color:#92400e; }
    h2 { color:#b45309; }
    .card { background:#fffbeb; border-radius:16px; padding:16px; box-shadow:0 6px 16px rgba(0,0,0,0.08); margin-bottom:16px; }
    label { display:block; margin-top:12px; font-weight:600; }
    input, select, button { width:100%; padding:10px; margin-top:6px; border-radius:10px; border:1px solid #d6d3d1; font-size:1rem; }
    button { background:#f59e0b; color:#78350f; border:none; margin-top:12px; font-weight:600; }
    button.secondary { background:#fde68a; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { border-bottom:1px solid #fde68a; padding:8px; font-size:0.8rem; }
    img { max-width:60px; border-radius:8px; }
    .admin-only { display:none; }
    body.admin .admin-only { display:block; }
  </style>
</head>
<body>
<h1>â˜€ï¸ ä¸Šä¸‹ç­ / åŠ ç­æ‰“å¡</h1>

<div class="card">
  <h2>ğŸ” ç®¡ç†æ¨¡å¼</h2>
  <input id="adminPin" type="password" placeholder="è¼¸å…¥ç®¡ç† PINï¼ˆé è¨­ 1234ï¼‰" />
  <button class="secondary" onclick="toggleAdmin()">é€²å…¥ / é›¢é–‹ ç®¡ç†æ¨¡å¼</button>
</div>

<div class="card admin-only">
  <h2>ğŸ¢ ç®¡ç†ï¼šè¾¦å…¬å®¤åœ°é»</h2>
  <input id="officeSetting" placeholder="è²¼ä¸Š Google Maps é€£çµæˆ–åœ°å€" />
  <button onclick="saveOffice()">ğŸ’¾ å„²å­˜ / ä¿®æ”¹ è¾¦å…¬å®¤åœ°é»</button>
</div>

<div class="card">
  <h2>ğŸ“ æ‰‹å‹•å–å¾— GPS ä½ç½®</h2>
  <ol style="font-size:0.9rem; line-height:1.6; padding-left:18px;">
    <li>é–‹å•Ÿ Google Maps</li>
    <li>é•·æŒ‰ç›®å‰ä½ç½®</li>
    <li>åˆ†äº« â†’ è¤‡è£½é€£çµ</li>
    <li>è²¼åˆ° GPS æ¬„ä½</li>
  </ol>

  <label>å§“å</label>
  <input id="nameInput" />

  <label>æ‰“å¡é¡å‹</label>
  <select id="type">
    <option value="ä¸Šç­">ä¸Šç­</option>
    <option value="ä¸‹ç­">ä¸‹ç­</option>
    <option value="åŠ ç­">åŠ ç­</option>
  </select>

  <label>æ—¥æœŸæ™‚é–“</label>
  <input id="datetime" type="datetime-local" />

  <label>å¸¸ç”¨åœ°é»</label>
  <select id="presetLocation" onchange="applyPreset()"></select>

  <label>GPS ä½ç½®</label>
  <input id="gpsLocation" placeholder="è²¼ä¸Šåœ°åœ–é€£çµæˆ–è¼¸å…¥åœ°å€" />

  <label>æ‹ç…§å­˜è­‰</label>
  <input id="photo" type="file" accept="image/*" capture="environment" />

  <button onclick="saveRecord()">âœ… æ‰“å¡</button>
</div>

<div class="card">
  <h2>ğŸ“Š æœˆå·¥æ™‚çµ±è¨ˆ</h2>
  <div id="summary"></div>
  <button class="secondary" onclick="exportExcel()">ğŸ“ åŒ¯å‡º Excelï¼ˆå«æœˆçµ±è¨ˆï¼‰</button>
</div>

<div class="card">
  <h2>ğŸ“„ æ‰“å¡ç´€éŒ„ï¼ˆç®¡ç†æ¨¡å¼å¯ä¿®æ”¹åœ°é»ï¼‰</h2>
  <table>
    <thead><tr><th>å§“å</th><th>é¡å‹</th><th>æ™‚é–“</th><th>åŠ ç­</th><th>åœ°é»</th><th>ç…§ç‰‡</th></tr></thead>
    <tbody id="records"></tbody>
  </table>
</div>

<section class="card">
  <h3>ğŸ“„ åŒ¯å‡ºæ­£å¼ç´€éŒ„ï¼ˆPDFï¼‰</h3>
  <p>ä¾ç›®å‰è³‡æ–™ç”¢å‡ºæ­£å¼ PDFï¼ˆå«å§“åé¦–é ã€å›ºå®šè¡¨é ­ã€è·¨é ï¼‰ã€‚</p>
  <button type="button" onclick="exportPDF()">â¬‡ï¸ åŒ¯å‡º PDF</button>
</section>

<script>
const KEY = 'clock_records_v6';
const OFFICE_KEY = 'office_location';
const PRESET_KEY = 'preset_locations';
const PIN_KEY = 'admin_pin';
const AUDIT_KEY = 'audit_logs';
// Â© WeyCalaw æ“æœ‰æœ¬ç³»çµ±ç¨‹å¼ç¢¼ç‰ˆæ¬Š

// å¸¸ç”¨åœ°é»é è¨­
if (!localStorage.getItem(PRESET_KEY)) {
  localStorage.setItem(PRESET_KEY, JSON.stringify([
    { name: 'å…¬å¸', gps: '' },
    { name: 'å®¶è£¡', gps: '' }
  ]));
}

let isAdmin = false;
let adminName = '';

function toggleAdmin() {
  const savedPin = localStorage.getItem(PIN_KEY) || '1234';
  const pinInput = document.getElementById('adminPin');
  if (pinInput.value !== savedPin) return alert('PIN éŒ¯èª¤');
  adminName = prompt('è«‹è¼¸å…¥ç®¡ç†è€…å§“åï¼ˆä½œç‚ºæ“ä½œç´€éŒ„ï¼‰') || 'ç®¡ç†è€…';
  isAdmin = !isAdmin;
  document.body.classList.toggle('admin', isAdmin);
  load();
}

function logAudit(action, detail) {
  const logs = JSON.parse(localStorage.getItem(AUDIT_KEY) || '[]');
  logs.push({ time: new Date().toISOString(), admin: adminName, action, detail });
  localStorage.setItem(AUDIT_KEY, JSON.stringify(logs));
}

function saveOffice() {
  const officeInput = document.getElementById('officeSetting');
  localStorage.setItem(OFFICE_KEY, officeInput.value);
  logAudit('ä¿®æ”¹è¾¦å…¬å®¤åœ°é»', officeInput.value);
  initPreset();
}

function initPreset() {
  const office = localStorage.getItem(OFFICE_KEY);
  const custom = JSON.parse(localStorage.getItem(PRESET_KEY) || '[]');
  const presetSelect = document.getElementById('presetLocation');
  presetSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>' +
    (office ? '<option value="office">è¾¦å…¬å®¤</option>' : '') +
    custom.map((p,i)=>`<option value="c${i}">${p.name}</option>`).join('');
}

function applyPreset() {
  const office = localStorage.getItem(OFFICE_KEY);
  const custom = JSON.parse(localStorage.getItem(PRESET_KEY) || '[]');
  const presetSelect = document.getElementById('presetLocation');
  const gpsInput = document.getElementById('gpsLocation');
  if (presetSelect.value === 'office') gpsInput.value = office || '';
  if (presetSelect.value.startsWith('c')) gpsInput.value = custom[presetSelect.value.slice(1)].gps;
}

function saveRecord() {
  const nameInput = document.getElementById('nameInput');
  const datetimeInput = document.getElementById('datetime');
  const typeSelect = document.getElementById('type');
  const gpsInput = document.getElementById('gpsLocation');
  const photoInput = document.getElementById('photo');

  // é˜²å‘†æç¤º
  if (!nameInput.value.trim()) return alert('è«‹å¡«å¯«å§“å');
  if (!datetimeInput.value) return alert('è«‹é¸æ“‡æ—¥æœŸæ™‚é–“');
  if (!gpsInput.value.trim()) return alert('è«‹è¼¸å…¥æˆ–é¸æ“‡ GPS ä½ç½®');
  if (!typeSelect.value) return alert('è«‹é¸æ“‡æ‰“å¡é¡å‹');

  const reader = new FileReader();
  const file = photoInput.files[0];
  reader.onload = () => {
    const dt = new Date(datetimeInput.value);
    const overtime = typeSelect.value === 'åŠ ç­' || dt.getHours() >= 18;
    const record = {
      name: nameInput.value,
      type: typeSelect.value,
      datetime: datetimeInput.value,
      overtime,
      location: gpsInput.value,
      image: reader.result || null
    };
    const data = JSON.parse(localStorage.getItem(KEY) || '[]');
    data.push(record);
    localStorage.setItem(KEY, JSON.stringify(data));
    load();
  };
  if (file) reader.readAsDataURL(file); else reader.onload();
}

function load() {
  const data = JSON.parse(localStorage.getItem(KEY) || '[]');
  const recordsTbody = document.getElementById('records');
  recordsTbody.innerHTML = '';
  const summaryDiv = document.getElementById('summary');
  const monthly = {};

  data.forEach((r, idx) => {
    const m = r.datetime.slice(0,7);
    if (!monthly[m]) monthly[m] = { work:0, overtime:0 };
    if (r.type === 'ä¸‹ç­') monthly[m].work += 8;
    if (r.overtime) monthly[m].overtime += 1;

    const locCell = isAdmin
      ? `<input value="${r.location}" onchange="updateLocation(${idx}, this.value)">`
      : r.location;

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.name}</td><td>${r.type}</td><td>${r.datetime}</td><td>${r.overtime?'æ˜¯':'å¦'}</td><td>${locCell}</td><td>${r.image?'<img src="'+r.image+'">':''}</td>`;
    recordsTbody.appendChild(tr);
  });

  summaryDiv.innerHTML = Object.entries(monthly)
    .map(([m,v])=>`ğŸ“… ${m}ï¼šå·¥æ™‚ ${v.work} å°æ™‚ / åŠ ç­ ${v.overtime} å°æ™‚`)
    .join('<br>');
}

function updateLocation(index, value) {
  const data = JSON.parse(localStorage.getItem(KEY) || '[]');
  const old = data[index].location;
  data[index].location = value;
  localStorage.setItem(KEY, JSON.stringify(data));
  logAudit('ä¿®æ”¹æ‰“å¡åœ°é»', `ç¬¬${index+1}ç­†ï¼š${old} â†’ ${value}`);
}

function exportExcel() {
  const data = JSON.parse(localStorage.getItem(KEY) || '[]');
  const ws1 = XLSX.utils.json_to_sheet(data);
  const summary = {};
  data.forEach(r=>{
    const m = r.datetime.slice(0,7);
    if (!summary[m]) summary[m] = { æœˆä»½:m, å·¥æ™‚:0, åŠ ç­:0 };
    if (r.type==='ä¸‹ç­') summary[m].å·¥æ™‚ += 8;
    if (r.overtime) summary[m].åŠ ç­ += 1;
  });
  const ws2 = XLSX.utils.json_to_sheet(Object.values(summary));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws1, 'æ‰“å¡ç´€éŒ„');
  XLSX.utils.book_append_sheet(wb, ws2, 'æœˆçµ±è¨ˆ');
  XLSX.writeFile(wb, 'clock_records.xlsx');
}

function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const data = JSON.parse(localStorage.getItem(KEY) || '[]');
  const user = data[0]?.name || '';
  const now = new Date();

  let y = 20;
  doc.setFontSize(14);
  doc.text('ä¸Šä¸‹ç­ / åŠ ç­æ‰“å¡ç´€éŒ„', 10, y);
  y += 8;
  doc.setFontSize(11);
  doc.text(`å§“åï¼š${user}`, 10, y);
  y += 6;
  doc.text(`åŒ¯å‡ºè€…ï¼š${adminName || 'æœ¬äºº'}`, 10, y);
  y += 6;
  doc.text(`åŒ¯å‡ºæ™‚é–“ï¼š${now.toLocaleString()}`, 10, y);
  y += 10;

  const header = ['å§“å','é¡å‹','æ™‚é–“','åŠ ç­','åœ°é»'];
  const drawHeader = () => {
    doc.setFontSize(10);
    let x = 10;
    header.forEach(h => { doc.text(h, x, y); x += 38; });
    y += 6;
  };

  drawHeader();
  data.forEach(r => {
    if (y > 280) {
      doc.addPage();
      y = 20;
      drawHeader();
    }
    const row = [r.name, r.type, r.datetime, r.overtime?'æ˜¯':'å¦', r.location];
    let x = 10;
    row.forEach(c => { doc.text(String(c), x, y); x += 38; });
    y += 6;
  });

  doc.addPage();
  doc.setFontSize(13);
  doc.text('æ¯æœˆåŠ ç­å°è¨ˆ', 10, 20);
  const monthly = {};
  data.forEach(r => {
    const m = r.datetime.slice(0,7);
    if (!monthly[m]) monthly[m] = 0;
    if (r.overtime) monthly[m] += 1;
  });
  let yy = 30;
  Object.entries(monthly).forEach(([m,v]) => {
    doc.text(`${m}ï¼šåŠ ç­ ${v} å°æ™‚`, 10, yy);
    yy += 8;
  });

  doc.save(`æ‰“å¡ç´€éŒ„_${user}.pdf`);
}

initPreset();
load();
</script>
</body>
</html>
