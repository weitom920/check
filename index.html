<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä¸Šä¸‹ç­ / åŠ ç­æ‰“å¡ï¼ˆæœ¬æ©Ÿå„²å­˜ï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background:#fff7ed; padding:16px; }
    h1 { font-size:1.6rem; color:#92400e; }
    h2 { color:#b45309; }
    .card { background:#fffbeb; border-radius:16px; padding:16px; box-shadow:0 6px 16px rgba(0,0,0,0.08); margin-bottom:16px; }
    label { display:block; margin-top:12px; font-weight:600; }
    input, select, button { width:100%; padding:10px; margin-top:6px; border-radius:10px; border:1px solid #d6d3d1; font-size:1rem; }
    button { background:#f59e0b; color:#78350f; border:none; margin-top:12px; font-weight:600; }
    button.secondary { background:#fde68a; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { border-bottom:1px solid #fde68a; padding:8px; font-size:0.8rem; }
    img { max-width:60px; border-radius:8px; }
    .admin-only { display:none; }
    body.admin .admin-only { display:block; }
  </style>
</head>
<body>
<h1>â˜€ï¸ ä¸Šä¸‹ç­ / åŠ ç­æ‰“å¡</h1>

<div class="card">
  <h2>ğŸ” ç®¡ç†æ¨¡å¼</h2>
  <input id="adminPin" type="password" placeholder="è¼¸å…¥ç®¡ç† PINï¼ˆé è¨­ 1234ï¼‰" />
  <button class="secondary" onclick="toggleAdmin()">é€²å…¥ / é›¢é–‹ ç®¡ç†æ¨¡å¼</button>
</div>

<div class="card admin-only">
  <h2>ğŸ¢ ç®¡ç†ï¼šè¾¦å…¬å®¤åœ°é»</h2>
  <input id="officeSetting" placeholder="è²¼ä¸Š Google Maps é€£çµæˆ–åœ°å€" />
  <button onclick="saveOffice()">ğŸ’¾ å„²å­˜ / ä¿®æ”¹ è¾¦å…¬å®¤åœ°é»</button>
</div>

<div class="card">
  <h2>ğŸ“ æ‰‹å‹•å–å¾— GPS ä½ç½®</h2>
  <ol style="font-size:0.9rem; line-height:1.6; padding-left:18px;">
    <li>é–‹å•Ÿ Google Maps</li>
    <li>é•·æŒ‰ç›®å‰ä½ç½®</li>
    <li>åˆ†äº« â†’ è¤‡è£½é€£çµ</li>
    <li>è²¼åˆ° GPS æ¬„ä½</li>
  </ol>

  <label>å§“å</label>
  <input id="nameInput" />

  <label>æ‰“å¡é¡å‹</label>
  <select id="type">
    <option value="ä¸Šç­">ä¸Šç­</option>
    <option value="ä¸‹ç­">ä¸‹ç­</option>
    <option value="åŠ ç­">åŠ ç­</option>
  </select>

  <label>æ—¥æœŸæ™‚é–“</label>
  <input id="datetime" type="datetime-local" />

  <label>å¸¸ç”¨åœ°é»</label>
  <select id="presetLocation" onchange="applyPreset()"></select>

  <label>GPS ä½ç½®</label>
  <input id="gpsLocation" placeholder="è²¼ä¸Šåœ°åœ–é€£çµæˆ–è¼¸å…¥åœ°å€" />

  <label>æ‹ç…§å­˜è­‰</label>
  <input id="photo" type="file" accept="image/*" capture="environment" />

  <button onclick="saveRecord()">âœ… æ‰“å¡</button>
</div>

<div class="card">
  <h2>ğŸ“Š æœˆå·¥æ™‚çµ±è¨ˆ</h2>
  <div id="summary"></div>
</div>

<div class="card">
  <h2>ğŸ“„ æ‰“å¡ç´€éŒ„ï¼ˆç®¡ç†æ¨¡å¼å¯ä¿®æ”¹åœ°é»ï¼‰</h2>
  <div style="display:flex; gap:8px; margin-bottom:8px;">
    <button class="secondary" onclick="exportExcel()">ğŸ“ åŒ¯å‡º Excelï¼ˆå«æœˆçµ±è¨ˆï¼‰</button>
    <button class="secondary" onclick="exportPDF()">ğŸ“„ åŒ¯å‡ºæ­£å¼ç´€éŒ„ï¼ˆPDFï¼‰</button>
  </div>
  <table>
    <thead><tr><th>å§“å</th><th>é¡å‹</th><th>æ™‚é–“</th><th>åŠ ç­</th><th>åœ°é»</th><th>ç…§ç‰‡</th></tr></thead>
    <tbody id="records"></tbody>
  </table>
</div>



<audio id="ding" src="https://www.soundjay.com/button/beep-07.wav" preload="auto"></audio>

<script>
const KEY = 'clock_records_v6';
const OFFICE_KEY = 'office_location';
const PRESET_KEY = 'preset_locations';
const PIN_KEY = 'admin_pin';
const AUDIT_KEY = 'audit_logs';
let isAdmin = false;
let adminName = '';

if (!localStorage.getItem(PRESET_KEY)) {
  localStorage.setItem(PRESET_KEY, JSON.stringify([
    { name: 'å…¬å¸', gps: '' },
    { name: 'å®¶è£¡', gps: '' }
  ]));
}

function toggleAdmin() {
  const savedPin = localStorage.getItem(PIN_KEY) || '1234';
  const pinInput = document.getElementById('adminPin');
  if (pinInput.value !== savedPin) return alert('PIN éŒ¯èª¤');
  adminName = prompt('è«‹è¼¸å…¥ç®¡ç†è€…å§“åï¼ˆä½œç‚ºæ“ä½œç´€éŒ„ï¼‰') || 'ç®¡ç†è€…';
  isAdmin = !isAdmin;
  document.body.classList.toggle('admin', isAdmin);
  load();
}

function logAudit(action, detail) {
  const logs = JSON.parse(localStorage.getItem(AUDIT_KEY) || '[]');
  logs.push({ time: new Date().toISOString(), admin: adminName, action, detail });
  localStorage.setItem(AUDIT_KEY, JSON.stringify(logs));
}

function saveOffice() {
  const officeInput = document.getElementById('officeSetting');
  localStorage.setItem(OFFICE_KEY, officeInput.value);
  logAudit('ä¿®æ”¹è¾¦å…¬å®¤åœ°é»', officeInput.value);
  initPreset();
  load();
}

function initPreset() {
  const office = localStorage.getItem(OFFICE_KEY);
  const custom = JSON.parse(localStorage.getItem(PRESET_KEY) || '[]');
  const presetSelect = document.getElementById('presetLocation');
  presetSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>' +
    (office ? '<option value="office">è¾¦å…¬å®¤</option>' : '') +
    custom.map((p,i)=>`<option value="c${i}">${p.name}</option>`).join('');
}

function applyPreset() {
  const office = localStorage.getItem(OFFICE_KEY);
  const custom = JSON.parse(localStorage.getItem(PRESET_KEY) || '[]');
  const presetSelect = document.getElementById('presetLocation');
  const gpsInput = document.getElementById('gpsLocation');
  if (presetSelect.value === 'office') gpsInput.value = office || '';
  if (presetSelect.value.startsWith('c')) gpsInput.value = custom[presetSelect.value.slice(1)].gps;
}

function saveRecord() {
  const nameInput = document.getElementById('nameInput');
  const datetimeInput = document.getElementById('datetime');
  const typeSelect = document.getElementById('type');
  const gpsInput = document.getElementById('gpsLocation');
  const presetSelect = document.getElementById('presetLocation');
  const photoInput = document.getElementById('photo');

  if (!nameInput.value.trim()) return alert('è«‹å¡«å¯«å§“å');
  if (!datetimeInput.value) return alert('è«‹é¸æ“‡æ—¥æœŸæ™‚é–“');
  if (!gpsInput.value.trim() && !presetSelect.value) return alert('è«‹è¼¸å…¥ GPS ä½ç½®æˆ–é¸æ“‡å¸¸ç”¨åœ°é»');
  if (!typeSelect.value) return alert('è«‹é¸æ“‡æ‰“å¡é¡å‹');

  const reader = new FileReader();
  const file = photoInput.files[0];
  reader.onload = () => {
    const dt = new Date(datetimeInput.value);
    const overtime = typeSelect.value === 'åŠ ç­' || dt.getHours() >= 18;
    const locationValue = gpsInput.value.trim() || (presetSelect.value === 'office' ? localStorage.getItem(OFFICE_KEY) : JSON.parse(localStorage.getItem(PRESET_KEY))[presetSelect.value.slice(1)].gps);
    const record = {
      name: nameInput.value,
      type: typeSelect.value,
      datetime: datetimeInput.value,
      overtime,
      location: locationValue,
      image: reader.result || null
    };
    const data = JSON.parse(localStorage.getItem(KEY) || '[]');
    data.push(record);
    localStorage.setItem(KEY, JSON.stringify(data));
    load();
    document.getElementById('ding').play();
    alert('âœ… æ‰“å¡æˆåŠŸ');
  };
  if (file) reader.readAsDataURL(file); else reader.onload();
}

function load() {
  const data = JSON.parse(localStorage.getItem(KEY) || '[]');
  const recordsTbody = document.getElementById('records');
  recordsTbody.innerHTML = '';
  const summaryDiv = document.getElementById('summary');
  const monthly = {};

  data.forEach((r, idx) => {
    const m = r.datetime.slice(0,7);
    if (!monthly[m]) monthly[m] = { work:0, overtime:0 };
    if (r.type === 'ä¸‹ç­') monthly[m].work += 8;
    if (r.overtime) monthly[m].overtime += 1;

    const locCell = isAdmin
      ? `<input value="${r.location}" onchange="updateLocation(${idx}, this.value)" style='width:100%'>`
      : r.location;

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.name}</td><td>${r.type}</td><td>${r.datetime}</td><td>${r.overtime?'æ˜¯':'å¦'}</td><td>${locCell}</td><td>${r.image?'<img src="'+r.image+'">':''}</td>`;
    recordsTbody.appendChild(tr);
  });

  summaryDiv.innerHTML = Object.entries(monthly)
    .map(([m,v])=>`ğŸ“… ${m}ï¼šå·¥æ™‚ ${v.work} å°æ™‚ / åŠ ç­ ${v.overtime} å°æ™‚`)
    .join('<br>');
}

function updateLocation(index, value) {
  const data = JSON.parse(localStorage.getItem(KEY) || '[]');
  const old = data[index].location;
  data[index].location = value;
  localStorage.setItem(KEY, JSON.stringify(data));
  logAudit('ä¿®æ”¹æ‰“å¡åœ°é»', `ç¬¬${index+1}ç­†ï¼š${old} â†’ ${value}`);
  load();
}

function exportExcel() {
  try {
    const data = JSON.parse(localStorage.getItem(KEY) || '[]');
    if (!data.length) return alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');

    const ws1 = XLSX.utils.json_to_sheet(data.map(r => ({
      å§“å: r.name,
      é¡å‹: r.type,
      æ™‚é–“: r.datetime,
      åŠ ç­: r.overtime ? 'æ˜¯' : 'å¦',
      åœ°é»: r.location
    })));

    const monthly = {};
    data.forEach(r => {
      const m = r.datetime.slice(0,7);
      if (!monthly[m]) monthly[m] = { æœˆä»½: m, å·¥æ™‚: 0, åŠ ç­: 0 };
      if (r.type === 'ä¸‹ç­') monthly[m].å·¥æ™‚ += 8;
      if (r.overtime) monthly[m].åŠ ç­ += 1;
    });
    const ws2 = XLSX.utils.json_to_sheet(Object.values(monthly));

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws1, 'æ‰“å¡ç´€éŒ„');
    XLSX.utils.book_append_sheet(wb, ws2, 'æœˆçµ±è¨ˆ');

    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([wbout], { type: 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'clock_records.xlsx';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    alert('âœ… Excel åŒ¯å‡ºå®Œæˆï¼Œè«‹é¸æ“‡å„²å­˜ä½ç½®');
  } catch (e) {
    alert('âŒ åŒ¯å‡ºå¤±æ•—: ' + e);
    console.error(e);
  }
}
}

async function exportPDF() {
  try {
    const { jsPDF } = window.jspdf;
    const data = JSON.parse(localStorage.getItem(KEY) || '[]');
    if (!data.length) return alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');

    const user = data[0]?.name || '';
    const doc = new jsPDF();
    const now = new Date();

    let y = 20;
    doc.setFontSize(14);
    doc.text('ä¸Šä¸‹ç­ / åŠ ç­æ‰“å¡ç´€éŒ„', 10, y);
    y += 8;
    doc.setFontSize(11);
    doc.text(`å§“åï¼š${user}`, 10, y);
    y += 6;
    doc.text(`åŒ¯å‡ºè€…ï¼š${adminName || 'æœ¬äºº'}`, 10, y);
    y += 6;
    doc.text(`åŒ¯å‡ºæ™‚é–“ï¼š${now.toLocaleString()}`, 10, y);
    y += 10;

    const header = ['å§“å', 'é¡å‹', 'æ™‚é–“', 'åŠ ç­', 'åœ°é»'];
    const drawHeader = () => {
      doc.setFontSize(10);
      let x = 10;
      header.forEach(h => { doc.text(h, x, y); x += 38; });
      y += 6;
    };
    drawHeader();

    data.forEach(r => {
      if (y > 280) { doc.addPage(); y = 20; drawHeader(); }
      let x = 10;
      [r.name, r.type, r.datetime, r.overtime ? 'æ˜¯' : 'å¦', r.location]
        .forEach(c => { doc.text(String(c), x, y); x += 38; });
      y += 6;
    });

    const blob = doc.output('blob');
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `æ‰“å¡ç´€éŒ„_${user}.pdf`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    alert('âœ… PDF åŒ¯å‡ºå®Œæˆï¼Œè«‹é¸æ“‡å„²å­˜ä½ç½®');
  } catch (e) {
    alert('âŒ PDF åŒ¯å‡ºå¤±æ•—: ' + e);
    console.error(e);
  }
}
      let x = 10;
      [r.name,r.type,r.datetime,r.overtime?'æ˜¯':'å¦',r.location].forEach(c => { doc.text(String(c), x, y); x += 38; });
      y += 6;
    });

    const monthly = {};
    data.forEach(r => { const m = r.datetime.slice(0,7); if(!monthly[m]) monthly[m]=0; if(r.overtime) monthly[m]+=1; });
    doc.addPage();
    doc.setFontSize(13);
    doc.text('æ¯æœˆåŠ ç­å°è¨ˆ', 10, 20);
    let yy = 30;
    Object.entries(monthly).forEach(([m,v]) => { doc.text(`${m}ï¼šåŠ ç­ ${v} å°æ™‚`, 10, yy); yy+=8; });

    doc.save(`æ‰“å¡ç´€éŒ„_${user}.pdf`);
    alert('âœ… PDF åŒ¯å‡ºå®Œæˆ');
  } catch(e) { alert('âŒ PDF åŒ¯å‡ºå¤±æ•—: '+e); console.error(e); }
}

initPreset();
load();
</script>
</body>
</html>
